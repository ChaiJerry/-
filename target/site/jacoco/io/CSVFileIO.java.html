<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CSVFileIO.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Civil-aviation-recommended-subject</a> &gt; <a href="index.source.html" class="el_package">io</a> &gt; <span class="el_source">CSVFileIO.java</span></div><h1>CSVFileIO.java</h1><pre class="source lang-java linenums">package io;

import com.csvreader.*;
import org.apache.spark.sql.*;

import java.io.*;
import java.nio.charset.*;
import java.util.*;
import java.util.logging.*;

import static data_processer.DataConverter.*;
import static data_processer.DataParser.*;
import static io.SharedAttributes.*;
import static data_generating_system.FPGrowth.*;
import static io.MongoUtils.*;

public class CSVFileIO {

    //csv文件结果输出的目录路径
    private final String resultDirPath;
    //csv文件读取的路径，数组长度为types.length，数组下标与types对应
<span class="fc" id="L22">    private final String[] csvPaths = new String[types.length];</span>

    // 初始化日志记录器
<span class="fc" id="L25">    private static final Logger logger = Logger.getLogger(CSVFileIO.class.getName());</span>

    //得到订单数量
    public int getOrderNumber() {
<span class="nc" id="L29">        return orderNumber;</span>
    }

    //订单数量
    protected static int orderNumber;

    /**
     * 初始化CSVFileIO
     */
    public CSVFileIO(String resultDirPath, String pathT
            , String pathH, String pathM, String pathB
<span class="fc" id="L40">            , String pathI , String pathS) throws IOException {</span>
        // 初始化路径
        // 输出结果路径
<span class="fc" id="L43">        this.resultDirPath = resultDirPath;</span>
        // 机票订单相关数据csv文件路径
<span class="fc" id="L45">        csvPaths[TICKET] = pathT;</span>
        // 酒店相关数据csv文件路径
<span class="fc" id="L47">        csvPaths[HOTEL] = pathH;</span>
        // 餐食相关数据csv文件路径
<span class="fc" id="L49">        csvPaths[MEAL] = pathM;</span>
        // 行李相关数据csv文件路径
<span class="fc" id="L51">        csvPaths[BAGGAGE] = pathB;</span>
        // 保险相关数据csv文件路径
<span class="fc" id="L53">        csvPaths[INSURANCE] = pathI;</span>
        // 座位相关数据csv文件路径
<span class="fc" id="L55">        csvPaths[SEAT] = pathS;</span>
        // 初始化类型与索引的映射
<span class="fc bfc" id="L57" title="All 2 branches covered.">        for (int i = 0; i &lt; types.length; i++) {</span>
<span class="fc" id="L58">            type2index.put(types[i], i);</span>
        }
        //首先读取Ticket订单相关信息方便建立订单和属性之间的映射
<span class="fc" id="L61">        ticketMap = CSVFileIO.read(csvPaths[TICKET], &quot;T&quot;);</span>
        //训练用机票订单
<span class="fc" id="L63">        testTicketMap = getTestMap();</span>
        //测试用机票订单
<span class="fc" id="L65">        trainingTicketsMap = getTrainingMap();</span>
<span class="fc" id="L66">    }</span>

    public void csv2DB() throws IOException {
<span class="nc bnc" id="L69" title="All 2 branches missed.">        for(int i = 0; i &lt; types.length; i++) {</span>
<span class="nc" id="L70">            singleTypeCsv2database(i);</span>
        }
<span class="nc" id="L72">    }</span>

    public void singleTypeCsv2database(int type) throws IOException {
        //订单与属性之间的映射map
        Map&lt;String, List&lt;List&lt;String&gt;&gt;&gt; attributeMap;
<span class="nc bnc" id="L77" title="All 2 branches missed.">        if (type != TICKET) {</span>
            // 当读取的csv文件不是Ticket时，直接处理
<span class="nc" id="L79">            attributeMap = CSVFileIO.read(csvPaths[type], types[type]);</span>
<span class="nc" id="L80">            ordersMap2DB(attributeMap, type);</span>
        } else {
            // 当读取的csv文件是Ticket时
            // 将测试集放入数据库
<span class="nc" id="L84">            ordersMap2DB(getTestTicketMap(), type);</span>
        }
<span class="nc" id="L86">    }</span>

    /**
     * Convert a CSV file to a Dataset&lt;Row&gt;.
     */
    public Dataset&lt;Row&gt; singelTypeCsv2dataset(int type) throws IOException {
        //订单与属性之间的映射map
        Map&lt;String, List&lt;List&lt;String&gt;&gt;&gt; attributeMap;
<span class="pc bpc" id="L94" title="1 of 2 branches missed.">        if (type != TICKET) {</span>
            // 当读取的csv文件不是Ticket时，直接处理
<span class="fc" id="L96">            attributeMap = CSVFileIO.read(csvPaths[type], types[type]);</span>
            // 创建数据集
<span class="fc" id="L98">            List&lt;Row&gt; data = new ArrayList&lt;&gt;();</span>
            //筛选出能和机票订单号匹配的订单数据
            // 遍历机票的订单号，只将已经有对应的机票订单号的订单数据添加到data中
<span class="pc bpc" id="L101" title="1 of 2 branches missed.">            for (Iterator&lt;String&gt; iterator = trainingTicketsMap.keySet().iterator(); iterator.hasNext(); ) {</span>
<span class="nc" id="L102">                String key = iterator.next();</span>
                // 得到属性列表
<span class="nc" id="L104">                List&lt;List&lt;String&gt;&gt; attributeLists = attributeMap.get(key);</span>
                // 如果temp不为空，则将temp添加到data中
                // 若是为空则说明没有商品可以和该订单匹配，则跳过
<span class="nc bnc" id="L107" title="All 2 branches missed.">                if (attributeLists != null) {</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">                    for(List&lt;String&gt; attributeList : attributeLists) {</span>
<span class="nc" id="L109">                        attributeList.addAll(trainingTicketsMap.get(key).get(0));</span>
<span class="nc" id="L110">                        data.add(RowFactory.create(attributeList));</span>
<span class="nc" id="L111">                    }</span>
                }
<span class="nc" id="L113">            }</span>
            // 创建DataFrame，并指定模式，将List&lt;Row&gt;数据转换为Dataset&lt;Row&gt;
<span class="fc" id="L115">            logger.info(&quot;正在创建DataFrame&quot;);</span>
<span class="fc" id="L116">            return getDataFrame(data);</span>
        } else {
            // 当读取的csv文件是Ticket时
<span class="nc" id="L119">            List&lt;Row&gt; data = new ArrayList&lt;&gt;();</span>
            // 暂时不会有等于TICKET的情况，若是以后有，则可以添加在这个地方
<span class="nc" id="L121">            return getDataFrame(data);</span>
        }
    }

    public List&lt;List&lt;String&gt;&gt; singleTypeCsv2lists(int type) throws IOException{
<span class="nc" id="L126">        return dataset2stringlist(singelTypeCsv2dataset(type));</span>
    }

    /**
     * 将频繁项集转换为CSV文件
     * @param dataSet 频繁项集
     * @param type 商品类型
     */
    public void freItemSet2CSV(Dataset&lt;Row&gt; dataSet, int type) {
        // 创建 CSV Writer 对象, 参数说明（写入的文件路径，分隔符，编码格式)
<span class="nc" id="L136">        CsvWriter csvWriter = new CsvWriter(resultDirPath + &quot;\\FreqItemSet&quot; + FULL_NAMES[type] + &quot;.csv&quot;, ',', StandardCharsets.UTF_8);</span>
        try {
            // 定义 header 头
<span class="nc" id="L139">            String[] headers = {&quot;Ticket&quot;, FULL_NAMES[type], &quot;freq&quot;};</span>
            // 写入 header 头
<span class="nc" id="L141">            csvWriter.writeRecord(headers);</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">            for (Row r : dataSet.collectAsList()) {</span>
                //遍历r.getList(0)
                String temp;
<span class="nc" id="L145">                String[] columns = new String[3];</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">                for (int i = 0; i &lt; 3; i++) {</span>
<span class="nc" id="L147">                    columns[i] = &quot;&quot;;</span>
                }
<span class="nc bnc" id="L149" title="All 2 branches missed.">                for (Object s : r.getList(0)) {</span>
<span class="nc" id="L150">                    temp = s.toString() + &quot;; &quot;;</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">                    columns[temp.charAt(0) == 'T' ? 0 : 1] += temp;</span>
<span class="nc" id="L152">                }</span>
<span class="nc bnc" id="L153" title="All 4 branches missed.">                if (columns[0].isEmpty() || columns[1].isEmpty()) {</span>
<span class="nc" id="L154">                    continue;</span>
                }
<span class="nc" id="L156">                columns[2] = r.get(1).toString();</span>
<span class="nc" id="L157">                csvWriter.writeRecord(columns);</span>
<span class="nc" id="L158">            }</span>
<span class="nc" id="L159">        } catch (Exception e) {</span>
<span class="nc" id="L160">            logger.info(&quot;freItemSet2CSV error&quot;);</span>
        } finally {
<span class="nc" id="L162">            csvWriter.close();</span>
        }
<span class="nc" id="L164">    }</span>

    /**
     * 将关联规则写入到CSV文件
     * @param rules 关联规则
     * @param type  商品类型
     */
    public void rules2CSV(Dataset&lt;Row&gt; rules, int type) throws IOException {
        // 定义 header 头
<span class="nc" id="L173">        String[] headers = {&quot;TICKET&quot;, FULL_NAMES[type], &quot;confidence&quot;};</span>
        // 创建 CSV Writer 对象, 参数说明（写入的文件路径，分隔符，编码格式)
<span class="nc" id="L175">        CsvWriter csvWriter = new CsvWriter(resultDirPath + &quot;\\&quot; + &quot;AssociationRules&quot; + FULL_NAMES[type] + &quot;.csv&quot;, ',', StandardCharsets.UTF_8);</span>
        // 写入 header 头
<span class="nc" id="L177">        csvWriter.writeRecord(headers);</span>
        // 遍历 rules
<span class="nc bnc" id="L179" title="All 2 branches missed.">        for (Row r : rules.collectAsList()) {</span>
            // 获取 Row 的内容
<span class="nc" id="L181">            String[] columns = row2rule(r);</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">            if(columns.length != 0) {</span>
                //若是不为空则说明有效，写入CSV文件
<span class="nc" id="L184">                csvWriter.writeRecord(columns);</span>
            }
<span class="nc" id="L186">        }</span>
        // 关闭 CSV Writer
<span class="nc" id="L188">        csvWriter.close();</span>
<span class="nc" id="L189">    }</span>


    public Map&lt;String, List&lt;List&lt;String&gt;&gt;&gt; read(int type) throws IOException {
<span class="fc" id="L193">        return CSVFileIO.read(csvPaths[type], types[type]);</span>
    }

    /**
     * 读取CSV文件
     * @param path 文件路径
     * @param type 商品类型
     * @return 返回订单号和订单对应的商品属性之间的键值对 Map&lt;String, List&lt;String&gt;&gt;
     */
    public static Map&lt;String, List&lt;List&lt;String&gt;&gt;&gt; read(String path, String type) throws IOException {
        // 创建HashMap，key为订单号，value为订单对应的属性键值对
<span class="fc" id="L204">        HashMap&lt;String, List&lt;List&lt;String&gt;&gt;&gt; map = new HashMap&lt;&gt;();</span>
        // 第一参数：读取文件的路径 第二个参数：分隔符 第三个参数：字符集
<span class="fc" id="L206">        CsvReader csvReader = new CsvReader(path, ',', StandardCharsets.UTF_8);</span>
        // 读取表头
<span class="fc" id="L208">        csvReader.readHeaders();</span>
        //通过type判断调用哪个方法
        //将表头存入HeaderStorage之中，方便后续存入数据库
<span class="fc" id="L211">        itemAttributesStorage[type2index.get(type)] = new ItemAttributesStorage();</span>
        //得到对应的属性头类
<span class="fc" id="L213">        ItemAttributesStorage header = itemAttributesStorage[type2index.get(type)];</span>
<span class="fc bfc" id="L214" title="All 2 branches covered.">        for(int i=1;i&lt;csvReader.getHeaderCount();i++) {</span>
            //将表头存入HeaderStorage之中，方便后续存入数据库
<span class="fc" id="L216">            header.addAttribute(csvReader.getHeader(i));</span>
        }
<span class="pc bpc" id="L218" title="1 of 7 branches missed.">        switch (type) {</span>
            case &quot;M&quot;:
                //处理餐食数据
<span class="fc bfc" id="L221" title="All 2 branches covered.">                while (csvReader.readRecord()) {</span>
                    //订单数量计数
<span class="fc" id="L223">                    orderNumber++;</span>
<span class="fc" id="L224">                    dealM(csvReader, map);</span>
                }
                break;
            case &quot;T&quot;:
                //特殊处理机票数据的属性
                //添加处理后得到的属性头
<span class="fc" id="L230">                header.addAttribute(&quot;MONTH&quot;);</span>
<span class="fc" id="L231">                header.addAttribute(&quot;TO&quot;);</span>
<span class="fc" id="L232">                header.addAttribute(&quot;FROM&quot;);</span>
<span class="fc" id="L233">                header.addAttribute(&quot;HAVE_CHILD&quot;);</span>
                //读取csv文件时会将一些不需要的属性头删读入，这里需要删除
                //删去多余的属性头
<span class="fc" id="L236">                header.removeAttribute(&quot;T_VOYAGE&quot;);</span>
<span class="fc" id="L237">                header.removeAttribute(&quot;T_PASSENGER&quot;);</span>
                //遍历csv每一行中的内容
<span class="fc bfc" id="L239" title="All 2 branches covered.">                while (csvReader.readRecord()) {</span>
                    //订单数量计数
<span class="fc" id="L241">                    orderNumber++;</span>
<span class="fc" id="L242">                    dealT(csvReader, map);</span>
                }
                break;
            case &quot;B&quot;:
                //处理行李数据
<span class="fc bfc" id="L247" title="All 2 branches covered.">                while (csvReader.readRecord()) {</span>
                    //订单数量计数
<span class="fc" id="L249">                    orderNumber++;</span>
<span class="fc" id="L250">                    dealB(csvReader, map);</span>
                }
                break;
            case &quot;H&quot;:
                //删除入住和退房时间属性头
<span class="fc" id="L255">                header.removeAttribute(&quot;IN_DATE&quot;);</span>
<span class="fc" id="L256">                header.removeAttribute(&quot;OUT_DATE&quot;);</span>
                //处理酒店数据
<span class="fc bfc" id="L258" title="All 2 branches covered.">                while (csvReader.readRecord()) {</span>
                    //订单数量计数
<span class="fc" id="L260">                    orderNumber++;</span>
<span class="fc" id="L261">                    dealH(csvReader, map);</span>
                }
                break;
            case &quot;I&quot;:
                //处理保险数据
<span class="fc bfc" id="L266" title="All 2 branches covered.">                while (csvReader.readRecord()) {</span>
                    //订单数量计数
<span class="fc" id="L268">                    orderNumber++;</span>
<span class="fc" id="L269">                    dealI(csvReader, map);</span>
                }
                break;
            case &quot;S&quot;:
                //处理座位数据
<span class="fc bfc" id="L274" title="All 2 branches covered.">                while (csvReader.readRecord()) {</span>
                    //订单数量计数
<span class="fc" id="L276">                    orderNumber++;</span>
<span class="fc" id="L277">                    dealS(csvReader, map);</span>
                }
                break;
            default:
                break;
        }
<span class="fc" id="L283">        return map;</span>
    }

    //得到训练集
    public static Map&lt;String, List&lt;List&lt;String&gt;&gt;&gt; getTrainingMap()  {
        //得到训练集的keys
        Set&lt;String&gt; keys;
        try {
<span class="fc" id="L291">            keys = getTrainKeys();</span>
<span class="nc" id="L292">        } catch (IOException e) {</span>
<span class="nc" id="L293">            logger.info(&quot;无机票训练集数据&quot;);</span>
<span class="nc" id="L294">            return new HashMap&lt;&gt;();</span>
<span class="fc" id="L295">        }</span>
        //得到训练集
<span class="fc" id="L297">        return getTargetMap(keys);</span>
    }

    //得到测试集
    public static Map&lt;String, List&lt;List&lt;String&gt;&gt;&gt; getTestMap(){
        //得到测试集的keys
        Set&lt;String&gt; keys;
        try {
<span class="fc" id="L305">            keys = getTestKeys();</span>
<span class="nc" id="L306">        } catch (IOException e) {</span>
<span class="nc" id="L307">            logger.info(&quot;无机票测试集数据&quot;);</span>
<span class="nc" id="L308">            return new HashMap&lt;&gt;();</span>
<span class="fc" id="L309">        }</span>
        //得到测试集
<span class="fc" id="L311">        return getTargetMap(keys);</span>
    }

    //为了将训练集和测试集分开，读取csv中的训练集keys
    public static Set&lt;String&gt; getTrainKeys() throws IOException {
<span class="fc" id="L316">        Set&lt;String&gt; trainNumsSet = getNumsSet(</span>
                &quot;D:\\programms\\java_projects\\version_control\\测试数据2.0\\train_dataset.txt&quot;);
<span class="fc" id="L318">        return getKeys(trainNumsSet);</span>
    }

    public static Set&lt;String&gt; getTestKeys() throws IOException {
<span class="fc" id="L322">        Set&lt;String&gt; testNumsSet = getNumsSet(</span>
                &quot;D:\\programms\\java_projects\\version_control\\测试数据2.0\\test_dataset.txt&quot;);
<span class="fc" id="L324">        return getKeys(testNumsSet);</span>
    }

    //得到机票唯一标识符key的集合keys
    public static Set&lt;String&gt; getKeys(Set&lt;String&gt; numsSet) throws IOException {
<span class="fc" id="L329">        Set&lt;String&gt; keys = new HashSet&lt;&gt;();</span>
<span class="fc" id="L330">        String csvFilePath = &quot;D:\\programms\\java_projects\\version_control\\测试数据2.0\\ticket.csv&quot;;</span>
<span class="fc" id="L331">        try (BufferedReader br = new BufferedReader(new FileReader(csvFilePath))) {</span>
            String line;
<span class="fc bfc" id="L333" title="All 2 branches covered.">            while ((line = br.readLine()) != null) {</span>
<span class="fc bfc" id="L334" title="All 2 branches covered.">                if(!numsSet.contains(line.split(&quot;,&quot;)[0])){</span>
<span class="fc" id="L335">                    continue;</span>
                }
<span class="fc" id="L337">                int commaIndex = line.indexOf(',');</span>
<span class="fc" id="L338">                String result = line.substring(commaIndex+1) + &quot;,&quot;;</span>
<span class="fc" id="L339">                keys.add(result);</span>
<span class="fc" id="L340">            }</span>
        }
<span class="fc" id="L342">        return keys;</span>
    }


    //从一个给定的txt文件中得到csv文件中所有订单号（训练集或测试集）
    public static Set&lt;String&gt; getNumsSet(String filePath) throws IOException {
<span class="fc" id="L348">        Set&lt;String&gt; nums = new HashSet&lt;&gt;();</span>
<span class="fc" id="L349">        try (BufferedReader br = new BufferedReader(new FileReader(filePath))) {</span>
            String line;
<span class="fc bfc" id="L351" title="All 2 branches covered.">            while ((line = br.readLine()) != null) {</span>
<span class="fc" id="L352">                nums.add(line);</span>
            }
        }
<span class="fc" id="L355">        return nums;</span>
    }



    //得到结果集合（是上面两个方法直接套用的方法）
    public static Map&lt;String, List&lt;List&lt;String&gt;&gt;&gt; getTargetMap(Set&lt;String&gt; keys){
        //返回的结果的map
<span class="fc" id="L363">        Map&lt;String, List&lt;List&lt;String&gt;&gt;&gt; targetMap = new HashMap&lt;&gt;();</span>
        //遍历ticketMap
<span class="fc bfc" id="L365" title="All 2 branches covered.">        for (Map.Entry&lt;String, List&lt;List&lt;String&gt;&gt;&gt; entry : ticketMap.entrySet()) {</span>
            //得到key
<span class="fc" id="L367">            String key = entry.getKey();</span>
            //得到ticketMap中属性列表的列表
<span class="fc" id="L369">            List&lt;List&lt;String&gt;&gt; listOfAttributeList = entry.getValue();</span>
<span class="fc bfc" id="L370" title="All 2 branches covered.">            for (List&lt;String&gt; attributeList : listOfAttributeList) {</span>
                // 得到机票的key（机票唯一标识符）
<span class="fc" id="L372">                String itemKey = generateItemKeyFromAttributes(attributeList);</span>
                // 如果机票的key在keys中，则将这个属性列表加入到targetMap的对应的属性列表的列表中
<span class="pc bpc" id="L374" title="1 of 2 branches missed.">                if (keys.contains(itemKey)) {</span>
                    // 如果targetMap中没有这个key，则新建一个属性列表的列表,否则直接获取这个key对应的属性列表的列表
<span class="nc" id="L376">                    List&lt;List&lt;String&gt;&gt; listOfAttributeListInDataSet = targetMap.getOrDefault(key, new ArrayList&lt;&gt;());</span>
                    // 将这个属性列表加入到属性列表的列表中
<span class="nc" id="L378">                    listOfAttributeListInDataSet.add(attributeList);</span>
                    // 将这个属性列表的列表加入或更新到targetMap中
<span class="nc" id="L380">                    targetMap.put(key, listOfAttributeListInDataSet);</span>
                }
<span class="fc" id="L382">            }</span>
<span class="fc" id="L383">        }</span>
<span class="fc" id="L384">        return targetMap;</span>
    }

    public static String generateItemKeyFromAttributes(List&lt;String&gt; attributes){
<span class="fc" id="L388">        StringBuilder stringBuilder=new StringBuilder();</span>
<span class="fc bfc" id="L389" title="All 2 branches covered.">        for(int i = 0; i &lt; attributes.size()-1;i++){</span>
<span class="fc" id="L390">            stringBuilder.append(attributes.get(i).split(&quot;:&quot;)[2]).append(&quot;,&quot;);</span>
        }
<span class="fc" id="L392">        return stringBuilder.toString();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>