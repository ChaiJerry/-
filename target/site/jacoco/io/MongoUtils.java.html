<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MongoUtils.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Civil-aviation-recommended-subject</a> &gt; <a href="index.source.html" class="el_package">io</a> &gt; <span class="el_source">MongoUtils.java</span></div><h1>MongoUtils.java</h1><pre class="source lang-java linenums">package io;

import com.mongodb.*;
import com.mongodb.MongoClient;
import com.mongodb.client.*;
import com.mongodb.client.model.*;
import org.apache.spark.sql.*;

import java.io.*;
import java.text.*;
import java.util.*;
import java.util.logging.*;

import org.bson.*;

import static com.mongodb.client.model.Projections.*;
import static data_processer.DataConverter.*;
import static io.SharedAttributes.*;

public class MongoUtils {

    private MongoUtils() {
    }

<span class="fc" id="L25">    private static MongoClient mongoClient = null;</span>
    private static MongoDatabase mongoOrdersDatabase;
    private static MongoDatabase mongoKnowledgeDatabase;
    private static final Properties properties;
    private static final String HOST;
    private static final int PORT;
    private static final String ORDERS_DB_NAME;
    private static final String KNOWLEDGE_DB_NAME;
    private static final String PASSWORD;
    private static final String USER;
    private static final String DB_SOURCE;
<span class="fc" id="L36">    private static final Logger logger = Logger.getLogger(MongoUtils.class.getName());</span>

    public static int getLatestTrainingNumber() {
<span class="nc" id="L39">        return Integer.parseInt(trainingNumber)-1;</span>
    }

    private static String trainingNumber;
    private static final String TRAINING_NUMBER_FIELD_NAME = &quot;trainingNumber&quot;;
    //训练的起始时间和结束时间
    private static String startTime;

<span class="fc" id="L47">    private static boolean isClosed = false;</span>

    /*
     * 读取配置文件
     */
    static {
<span class="fc" id="L53">        properties = new Properties();</span>
        try {
<span class="fc" id="L55">            InputStream stream = MongoUtils.class.getClassLoader().getResourceAsStream(&quot;MongoDB.properties&quot;);</span>
<span class="fc" id="L56">            properties.load(stream);</span>
<span class="nc" id="L57">        } catch (IOException e) {</span>
<span class="nc" id="L58">            logger.info(&quot;读取配置文件失败！&quot; + e.getClass().getName() + &quot;: &quot; + e.getMessage());</span>
<span class="fc" id="L59">        }</span>
<span class="fc" id="L60">        HOST = properties.getProperty(&quot;host&quot;);</span>
<span class="fc" id="L61">        ORDERS_DB_NAME = properties.getProperty(&quot;OrdersDbname&quot;);</span>
<span class="fc" id="L62">        KNOWLEDGE_DB_NAME = properties.getProperty(&quot;KnowledgeDbname&quot;);</span>
<span class="fc" id="L63">        PORT = Integer.parseInt(properties.getProperty(&quot;port&quot;));</span>
<span class="fc" id="L64">        USER = properties.getProperty(&quot;user&quot;);</span>
<span class="fc" id="L65">        PASSWORD = properties.getProperty(&quot;password&quot;);</span>
<span class="fc" id="L66">        DB_SOURCE = properties.getProperty(&quot;dbSource&quot;);</span>
<span class="fc" id="L67">        trainingNumber = properties.getProperty(TRAINING_NUMBER_FIELD_NAME);</span>
<span class="fc" id="L68">        initialMongoClient();</span>
<span class="fc" id="L69">    }</span>

    /*
     * 初始化MongoDB连接
     */
    private static void initialMongoClient() {
        //得到当前时间作为开始时间
<span class="fc" id="L76">        startTime = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;).format(new Date());</span>
        try {
            //获取ip和端口号
<span class="fc" id="L79">            ServerAddress serverAddress = new ServerAddress(HOST, PORT);</span>
<span class="fc" id="L80">            List&lt;ServerAddress&gt; addresses = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L81">            addresses.add(serverAddress);</span>
            //MongoCredential.createScramSha1Credential()三个参数分别为 用户名 数据库名称 密码
<span class="fc" id="L83">            MongoCredential credential = MongoCredential.createScramSha1Credential(USER,</span>
<span class="fc" id="L84">                    DB_SOURCE, PASSWORD.toCharArray());</span>
<span class="fc" id="L85">            List&lt;MongoCredential&gt; credentials = new ArrayList&lt;&gt;();</span>
            //将认证信息添加到列表
<span class="fc" id="L87">            credentials.add(credential);</span>
            //通过连接认证获取MongoDB连接
<span class="fc" id="L89">            mongoClient = new MongoClient(addresses, credentials);</span>
            //获取数据库
<span class="fc" id="L91">            mongoKnowledgeDatabase = mongoClient.getDatabase(KNOWLEDGE_DB_NAME);</span>
<span class="fc" id="L92">            mongoOrdersDatabase = mongoClient.getDatabase(ORDERS_DB_NAME);</span>
            //获取训练编号,若是auto则自动获取实现自增
<span class="pc bpc" id="L94" title="1 of 2 branches missed.">            if (trainingNumber.equals(&quot;auto&quot;)) {</span>
                //获取TrainingController集合
<span class="fc" id="L96">                MongoCollection&lt;Document&gt; collection = mongoKnowledgeDatabase.getCollection(&quot;TrainingController&quot;);</span>
                //查询最近的TrainingNumber
<span class="fc" id="L98">                FindIterable&lt;Document&gt; records = collection</span>
<span class="fc" id="L99">                        .find().sort(Sorts.descending(TRAINING_NUMBER_FIELD_NAME));</span>
                //如果存在训练编号，则自动获取
<span class="pc bpc" id="L101" title="1 of 2 branches missed.">                if (records.iterator().hasNext()) {</span>
<span class="fc" id="L102">                    Document doc = records.iterator().next();</span>
                    //获取训练编号
<span class="fc" id="L104">                    int number = Integer.parseInt(doc.get(TRAINING_NUMBER_FIELD_NAME).toString()) + 1;</span>
<span class="fc" id="L105">                    trainingNumber = Integer.toString(number);</span>
<span class="fc" id="L106">                    String info = &quot;自动获取训练编号：&quot; + number;</span>
<span class="fc" id="L107">                    logger.info(info);</span>
<span class="fc" id="L108">                } else {</span>
                    //否则自动获取1
<span class="nc" id="L110">                    logger.info(&quot;自动获取训练编号：1&quot;);</span>
<span class="nc" id="L111">                    trainingNumber = &quot;1&quot;;</span>
                }
            }
<span class="fc" id="L114">            logger.info(&quot;MongoDB连接成功！&quot;);</span>
<span class="nc" id="L115">        } catch (Exception e) {</span>
<span class="nc" id="L116">            logger.info(&quot;MongoDB连接失败！&quot; + e.getClass().getName() + &quot;: &quot; + e.getMessage());</span>
<span class="fc" id="L117">        }</span>
<span class="fc" id="L118">    }</span>

    public static void createOrdersCollections() {
<span class="nc bnc" id="L121" title="All 2 branches missed.">        for (String name : FULL_NAMES) {</span>
            //创建集合
<span class="nc" id="L123">            mongoOrdersDatabase.createCollection(name + ORDERS_FIELD_NAME);</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">            if (!Objects.equals(name, FULL_NAMES[TICKET])) {</span>
<span class="nc" id="L125">                mongoOrdersDatabase.createCollection(FULL_NAMES[TICKET] + &quot;-&quot; + name + ORDERS_FIELD_NAME);</span>
            }
        }
<span class="nc" id="L128">    }</span>

    public static void ordersMap2DB(Map&lt;String, List&lt;List&lt;String&gt;&gt;&gt; ordersMap, int type) {
<span class="nc" id="L131">        ItemAttributesStorage itemAttributesStorage = getHeaderStorage()[type];</span>
        //获取集合名称
<span class="nc" id="L133">        String collectionName = FULL_NAMES[type] + ORDERS_FIELD_NAME;</span>
<span class="nc" id="L134">        MongoCollection&lt;Document&gt; collection = mongoOrdersDatabase.getCollection(collectionName);</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">        for (Map.Entry&lt;String, List&lt;List&lt;String&gt;&gt;&gt; entry : ordersMap.entrySet()) {</span>
<span class="nc" id="L136">            List&lt;List&lt;String&gt;&gt; values = entry.getValue();</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">            for (List&lt;String&gt; value : values) {</span>
<span class="nc" id="L138">                Document doc = new Document();</span>
<span class="nc" id="L139">                doc.append(&quot;orderId&quot;, entry.getKey());</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">                if (!values.isEmpty()) {</span>
                    //借用频繁项集的存储结构，将属性存入
<span class="nc" id="L142">                    doc.append(&quot;attributes&quot;, itemAttributesStorage.getFrequentItemSetsDocument(value));</span>
<span class="nc" id="L143">                    collection.insertOne(doc);</span>
                }
<span class="nc" id="L145">            }</span>
<span class="nc" id="L146">        }</span>
<span class="nc" id="L147">    }</span>

    public static MongoCollection&lt;Document&gt; getRulesCollection(int type) {
        //获取集合名称
<span class="nc" id="L151">        String collectionName = &quot;r_&quot; + FULL_NAMES[type];</span>
<span class="nc" id="L152">        return mongoKnowledgeDatabase.getCollection(collectionName);</span>
    }

    public static MongoCollection&lt;Document&gt; getFrequentItemSetsCollection(int type) {
        //获取集合名称
<span class="fc" id="L157">        String collectionName = &quot;f_&quot; + FULL_NAMES[type];</span>
<span class="fc" id="L158">        return mongoKnowledgeDatabase.getCollection(collectionName);</span>
    }

    public static MongoCollection&lt;Document&gt; getOrdersCollection(int type) {
        //获取集合名称
<span class="nc" id="L163">        String collectionName = FULL_NAMES[type] + ORDERS_FIELD_NAME;</span>
<span class="nc" id="L164">        return mongoOrdersDatabase.getCollection(collectionName);</span>
    }

    public static void initializeItemAttributesStorages() {
<span class="nc bnc" id="L168" title="All 2 branches missed.">        for(int type = 1;type &lt;types.length;type++) {</span>
<span class="nc" id="L169">            itemAttributesStorage[type] = new ItemAttributesStorage();</span>
<span class="nc" id="L170">            MongoCollection&lt;Document&gt; collection = getFrequentItemSetsCollection(type);</span>
<span class="nc" id="L171">            FindIterable&lt;Document&gt; records = collection.find().sort(Sorts.descending(TRAINING_NUMBER_FIELD_NAME));</span>
            //只用找到一个频繁项集中的itemAttributes中的所有属性名即可
<span class="nc bnc" id="L173" title="All 2 branches missed.">            if (records.iterator().hasNext()) {</span>
<span class="nc" id="L174">                Document doc = records.iterator().next();</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">                if(type==1){</span>
<span class="nc" id="L176">                    itemAttributesStorage[0] = new ItemAttributesStorage();</span>
<span class="nc" id="L177">                    Set&lt;String&gt; strings = ((Document) (doc.get(TICKET_ATTRIBUTES_FIELD_NAME))).keySet();</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">                    for (String s : strings) {</span>
<span class="nc" id="L179">                        itemAttributesStorage[0].addAttribute(s);</span>
<span class="nc" id="L180">                    }</span>
                }
<span class="nc" id="L182">                Set&lt;String&gt; strings = ((Document) (doc.get(ITEM_ATTRIBUTES_FIELD_NAME))).keySet();</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">                for (String s : strings) {</span>
<span class="nc" id="L184">                    itemAttributesStorage[type].addAttribute(s);</span>
<span class="nc" id="L185">                }</span>
            }


        }
<span class="nc" id="L190">    }</span>

    public static List&lt;String&gt; getTargetItemFromOrderNum(String orderNumber, int type
            , MongoCollection&lt;Document&gt; collection) {
<span class="nc" id="L194">        FindIterable&lt;Document&gt; records = collection.find(Filters</span>
<span class="nc" id="L195">                .eq(&quot;orderId&quot;, orderNumber)).projection(fields(include(</span>
<span class="nc" id="L196">                getTargetItemFieldNames(type)), excludeId()));</span>
<span class="nc" id="L197">        List&lt;String&gt; targetItems = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L198">        MongoCursor&lt;Document&gt; iterator = records.iterator();</span>
<span class="nc bnc" id="L199" title="All 2 branches missed.">        while (iterator.hasNext()) {</span>
<span class="nc" id="L200">            targetItems.add(getItemNameFromDocument((iterator.next()),type));</span>
        }
<span class="nc" id="L202">        return targetItems;</span>
    }

    /**
     * 读取规则，并存入MongoDB
     */
    public static void rules2db(Dataset&lt;Row&gt; rules, int type) {
<span class="pc bpc" id="L209" title="1 of 2 branches missed.">        for (Row r : rules.collectAsList()) {</span>
            //处理第0列antecedent
<span class="nc" id="L211">            Document doc = new Document();</span>
<span class="nc" id="L212">            Document antecedent = new Document();</span>
            //得到对应的集合
<span class="nc" id="L214">            MongoCollection&lt;Document&gt; collection = mongoKnowledgeDatabase.getCollection(&quot;r_&quot; + FULL_NAMES[type]);</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">            if (itemAttributesStorage[TICKET].getRulesDocument(r.getList(0), antecedent)) {</span>
<span class="nc" id="L216">                doc.append(&quot;antecedent&quot;, antecedent);</span>
                //处理(consequent)
<span class="nc" id="L218">                String[] parts = r.getList(1).get(0).toString().split(&quot;:&quot;);</span>
                //如果consequent是机票类型的属性，则跳过
<span class="nc bnc" id="L220" title="All 2 branches missed.">                if (parts[0].charAt(0) == 'T') {</span>
<span class="nc" id="L221">                    continue;</span>
                }
                //添加consequent
<span class="nc" id="L224">                doc.append(&quot;consequence&quot;, parts[1] + &quot;:&quot; + parts[2]);</span>
                //添加置信度
<span class="nc" id="L226">                doc.append(&quot;confidence&quot;, Float.parseFloat(r.get(2).toString()));</span>
                //添加训练编号
<span class="nc" id="L228">                doc.append(TRAINING_NUMBER_FIELD_NAME, Integer.parseInt(trainingNumber));</span>
                //加入数据库
<span class="nc" id="L230">                collection.insertOne(doc);</span>
            }
<span class="nc" id="L232">        }</span>
<span class="fc" id="L233">    }</span>

    public static void frequentItemSets2db(Dataset&lt;Row&gt; itemSets, int type) {
<span class="fc" id="L236">        MongoCollection&lt;Document&gt; collection = mongoKnowledgeDatabase.getCollection(&quot;f_&quot; + FULL_NAMES[type]);</span>
<span class="pc bpc" id="L237" title="1 of 2 branches missed.">        for (Row r : itemSets.collectAsList()) {</span>
            //写入数据库的doc
<span class="nc" id="L239">            Document doc = new Document();</span>
            //初始化ticketAttributes和goodAttributes用于存储频繁项集
<span class="nc" id="L241">            List&lt;String&gt; ticketAttributes = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L242">            List&lt;String&gt; goodAttributes = new ArrayList&lt;&gt;();</span>
            //得到频繁项集
<span class="nc bnc" id="L244" title="All 2 branches missed.">            for (Object s : r.getList(0)) {</span>
<span class="nc" id="L245">                String temp = s.toString();</span>
                //如果频繁项集是机票类型的属性，则加入ticketAttributes
<span class="nc bnc" id="L247" title="All 2 branches missed.">                if (temp.charAt(0) == 'T') {</span>
<span class="nc" id="L248">                    ticketAttributes.add(temp);</span>
                } else {
                    //否则加入goodAttributes
<span class="nc" id="L251">                    goodAttributes.add(temp);</span>
                }
<span class="nc" id="L253">            }</span>
            //如果ticketAttributes或goodAttributes为空则无意义，跳过
<span class="nc bnc" id="L255" title="All 4 branches missed.">            if (ticketAttributes.isEmpty() || goodAttributes.isEmpty()) {</span>
<span class="nc" id="L256">                continue;</span>
            }
            //将ticketAttributes添加到doc
<span class="nc" id="L259">            doc.append(TICKET_ATTRIBUTES_FIELD_NAME, itemAttributesStorage[TICKET].getFrequentItemSetsDocument(ticketAttributes));</span>
            //将goodAttributes添加到doc
<span class="nc" id="L261">            doc.append(&quot;itemAttributes&quot;, itemAttributesStorage[type].getFrequentItemSetsDocument(goodAttributes));</span>
            //添加训练编号
<span class="nc" id="L263">            doc.append(TRAINING_NUMBER_FIELD_NAME, Integer.parseInt(trainingNumber));</span>
            //添加频次
<span class="nc" id="L265">            doc.append(&quot;Freq&quot;, Integer.parseInt(r.get(1).toString()));</span>
            //加入数据库
<span class="nc" id="L267">            collection.insertOne(doc);</span>
<span class="nc" id="L268">        }</span>
<span class="fc" id="L269">    }</span>

    /*
     * 关闭MongoDB连接
     */
    public static void closeMongoClient(int orderNumber, String comments, float minSupport) {
<span class="pc bpc" id="L275" title="1 of 2 branches missed.">        if (!isClosed) {</span>
            //得到当前时间作为结束时间
<span class="fc" id="L277">            String endTime = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;).format(new Date());</span>
            //获取TrainingController集合
<span class="fc" id="L279">            MongoCollection&lt;Document&gt; collection = mongoKnowledgeDatabase.getCollection(&quot;TrainingController&quot;);</span>
            //写入训练信息
<span class="fc" id="L281">            Document doc = new Document();</span>
            //训练编号以整数形式存储
<span class="fc" id="L283">            doc.append(TRAINING_NUMBER_FIELD_NAME, Integer.parseInt(trainingNumber));</span>
            //训练开始时间
<span class="fc" id="L285">            doc.append(&quot;startTime&quot;, startTime);</span>
            //训练结束时间
<span class="fc" id="L287">            doc.append(&quot;endTime&quot;, endTime);</span>
            //训练的订单数量
<span class="fc" id="L289">            doc.append(&quot;orderNumber&quot;, orderNumber);</span>
            //备注
<span class="fc" id="L291">            doc.append(&quot;comments&quot;, comments);</span>
            //最小支持度
<span class="fc" id="L293">            doc.append(&quot;minSupport&quot;, minSupport);</span>
            //将doc加入数据库
<span class="fc" id="L295">            collection.insertOne(doc);</span>
            try {
                //关闭MongoDB连接
<span class="fc" id="L298">                mongoClient.close();</span>
<span class="nc" id="L299">            } catch (Exception e) {</span>
<span class="nc" id="L300">                logger.info(&quot;关闭MongoDB连接失败！&quot; + e.getClass().getName() + &quot;: &quot; + e.getMessage());</span>
<span class="fc" id="L301">            }</span>
<span class="fc" id="L302">            isClosed = true;</span>
        }
<span class="fc" id="L304">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>