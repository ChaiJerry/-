<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MongoUtils.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Civil-aviation-recommended-subject</a> &gt; <a href="index.source.html" class="el_package">io</a> &gt; <span class="el_source">MongoUtils.java</span></div><h1>MongoUtils.java</h1><pre class="source lang-java linenums">package io;

import com.mongodb.*;
import com.mongodb.MongoClient;
import com.mongodb.client.*;
import com.mongodb.client.model.*;
import org.apache.spark.sql.*;

import java.io.*;
import java.text.*;
import java.util.*;
import java.util.logging.*;
import org.bson.*;
import static io.IOMonitor.*;

public class MongoUtils {
    private MongoUtils(){
    }
<span class="fc" id="L19">    private static MongoClient mongoClient = null;</span>
    private static MongoDatabase mongoDatabase;
    private static final Properties properties;
    private static final String HOST;
    private static final int PORT;
    private static final String DB_NAME;
    private static final String PASSWORD;
    private static final String USER;
    private static final String DB_SOURCE;
<span class="fc" id="L28">    private static final Logger logger = Logger.getLogger(MongoUtils.class.getName());</span>
    private static String trainingNumber;
    private static final String TRAINING_NUMBER_FIELD = &quot;trainingNumber&quot;;
    //训练的起始时间和结束时间
    private static String startTime;

<span class="fc" id="L34">    private static boolean isClosed= false;</span>



    /*
     * 读取配置文件
     */
    static{
<span class="fc" id="L42">        properties = new Properties();</span>
        try{
<span class="fc" id="L44">            InputStream stream = MongoUtils.class.getClassLoader().getResourceAsStream(&quot;MongoDB.properties&quot;);</span>
<span class="fc" id="L45">            properties.load(stream);</span>
<span class="nc" id="L46">        }catch (IOException e){</span>
<span class="nc" id="L47">            logger.info(&quot;读取配置文件失败！&quot; + e.getClass().getName() + &quot;: &quot; + e.getMessage());</span>
<span class="fc" id="L48">        }</span>
<span class="fc" id="L49">        HOST = properties.getProperty(&quot;host&quot;);</span>
<span class="fc" id="L50">        DB_NAME = properties.getProperty(&quot;dbname&quot;);</span>
<span class="fc" id="L51">        PORT = Integer.parseInt(properties.getProperty(&quot;port&quot;));</span>
<span class="fc" id="L52">        USER = properties.getProperty(&quot;user&quot;);</span>
<span class="fc" id="L53">        PASSWORD = properties.getProperty(&quot;password&quot;);</span>
<span class="fc" id="L54">        DB_SOURCE = properties.getProperty(&quot;dbSource&quot;);</span>
<span class="fc" id="L55">        trainingNumber = properties.getProperty(TRAINING_NUMBER_FIELD);</span>
<span class="fc" id="L56">        initialMongoClient();</span>
<span class="fc" id="L57">    }</span>

    /*
     * 初始化MongoDB连接
     */
    private static void initialMongoClient() {
        //得到当前时间作为开始时间
<span class="fc" id="L64">        startTime = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;).format(new Date());</span>
        try {
            //获取ip和端口号
<span class="fc" id="L67">            ServerAddress serverAddress = new ServerAddress(HOST, PORT);</span>
<span class="fc" id="L68">            List&lt;ServerAddress&gt; addresses = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L69">            addresses.add(serverAddress);</span>
            //MongoCredential.createScramSha1Credential()三个参数分别为 用户名 数据库名称 密码
<span class="fc" id="L71">            MongoCredential credential = MongoCredential.createScramSha1Credential(USER,</span>
<span class="fc" id="L72">                    DB_SOURCE, PASSWORD.toCharArray());</span>
<span class="fc" id="L73">            List&lt;MongoCredential&gt; credentials = new ArrayList&lt;&gt;();</span>
            //将认证信息添加到列表
<span class="fc" id="L75">            credentials.add(credential);</span>
            //通过连接认证获取MongoDB连接
<span class="fc" id="L77">            mongoClient = new MongoClient(addresses, credentials);</span>
            //获取数据库
<span class="fc" id="L79">            mongoDatabase = mongoClient.getDatabase(DB_NAME);</span>
            //获取训练编号,若是auto则自动获取实现自增
<span class="pc bpc" id="L81" title="1 of 2 branches missed.">            if(trainingNumber.equals(&quot;auto&quot;)){</span>
                //获取TrainingController集合
<span class="fc" id="L83">                MongoCollection&lt;Document&gt; collection = mongoDatabase.getCollection(&quot;TrainingController&quot;);</span>
                //查询最近的TrainingNumber
<span class="fc" id="L85">                FindIterable&lt;Document&gt; records = collection</span>
<span class="fc" id="L86">                        .find().sort(Sorts.descending(TRAINING_NUMBER_FIELD));</span>
                //如果存在训练编号，则自动获取
<span class="pc bpc" id="L88" title="1 of 2 branches missed.">                if (records.iterator().hasNext()) {</span>
<span class="fc" id="L89">                    Document doc = records.iterator().next();</span>
                    //获取训练编号
<span class="fc" id="L91">                    int number = Integer.parseInt(doc.get(TRAINING_NUMBER_FIELD).toString()) + 1;</span>
<span class="fc" id="L92">                    trainingNumber = Integer.toString(number);</span>
<span class="fc" id="L93">                    String info = &quot;自动获取训练编号：&quot; + number;</span>
<span class="fc" id="L94">                    logger.info(info);</span>
<span class="fc" id="L95">                }else {</span>
                    //否则自动获取1
<span class="nc" id="L97">                    logger.info(&quot;自动获取训练编号：1&quot;);</span>
<span class="nc" id="L98">                    trainingNumber = &quot;1&quot;;</span>
                }
            }
<span class="fc" id="L101">            logger.info(&quot;MongoDB连接成功！&quot;);</span>
<span class="nc" id="L102">        } catch (Exception e) {</span>
<span class="nc" id="L103">            logger.info(&quot;MongoDB连接失败！&quot; + e.getClass().getName() + &quot;: &quot; + e.getMessage());</span>
<span class="fc" id="L104">        }</span>
<span class="fc" id="L105">    }</span>



    /**
     * 读取规则，并存入MongoDB
     */
    public static void rules2db(Dataset&lt;Row&gt; rules, int type){
<span class="fc bfc" id="L113" title="All 2 branches covered.">        for (Row r : rules.collectAsList()) {</span>
            //处理第0列antecedent
<span class="fc" id="L115">            Document doc = new Document();</span>
<span class="fc" id="L116">            Document antecedent = new Document();</span>
            //得到对应的集合
<span class="fc" id="L118">            MongoCollection&lt;Document&gt; collection = mongoDatabase.getCollection(&quot;r_&quot;+FULL_NAMES[type]);</span>
<span class="fc bfc" id="L119" title="All 2 branches covered.">            if (headerStorage[TICKET].getRulesDocument(r.getList(0),antecedent)) {</span>
<span class="fc" id="L120">                doc.append(&quot;antecedent&quot;, antecedent);</span>
                //处理(consequent)
<span class="fc" id="L122">                String[] parts = r.getList(1).get(0).toString().split(&quot;:&quot;);</span>
                //如果consequent是机票类型的属性，则跳过
<span class="fc bfc" id="L124" title="All 2 branches covered.">                if (parts[0].charAt(0) == 'T') {</span>
<span class="fc" id="L125">                    continue;</span>
                }
                //添加consequent
<span class="fc" id="L128">                doc.append(&quot;consequence&quot;, parts[1]+&quot;:&quot;+parts[2]);</span>
                //添加置信度
<span class="fc" id="L130">                doc.append(&quot;confidence&quot;, Float.parseFloat(r.get(2).toString()));</span>
                //添加训练编号
<span class="fc" id="L132">                doc.append(TRAINING_NUMBER_FIELD, Integer.parseInt(trainingNumber));</span>
                //加入数据库
<span class="fc" id="L134">                collection.insertOne(doc);</span>
            }
<span class="fc" id="L136">        }</span>
<span class="fc" id="L137">    }</span>

    public static void frequentItemSets2db(Dataset&lt;Row&gt; itemSets, int type){
<span class="fc" id="L140">        MongoCollection&lt;Document&gt; collection = mongoDatabase.getCollection(&quot;f_&quot;+FULL_NAMES[type]);</span>
<span class="fc bfc" id="L141" title="All 2 branches covered.">        for (Row r : itemSets.collectAsList()) {</span>
            //写入数据库的doc
<span class="fc" id="L143">            Document doc = new Document();</span>
            //初始化ticketAttributes和goodAttributes用于存储频繁项集
<span class="fc" id="L145">            List&lt;String&gt; ticketAttributes = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L146">            List&lt;String&gt; goodAttributes = new ArrayList&lt;&gt;();</span>
            //得到频繁项集
<span class="fc bfc" id="L148" title="All 2 branches covered.">            for (Object s : r.getList(0)) {</span>
<span class="fc" id="L149">                String temp = s.toString();</span>
                //如果频繁项集是机票类型的属性，则加入ticketAttributes
<span class="fc bfc" id="L151" title="All 2 branches covered.">                if(temp.charAt(0) == 'T' ){</span>
<span class="fc" id="L152">                    ticketAttributes.add(temp);</span>
                }else {
                    //否则加入goodAttributes
<span class="fc" id="L155">                    goodAttributes.add(temp);</span>
                }
<span class="fc" id="L157">            }</span>
            //如果ticketAttributes或goodAttributes为空则无意义，跳过
<span class="fc bfc" id="L159" title="All 4 branches covered.">            if(ticketAttributes.isEmpty() || goodAttributes.isEmpty()) {</span>
<span class="fc" id="L160">                continue;</span>
            }
            //将ticketAttributes添加到doc
<span class="fc" id="L163">            doc.append(&quot;ticketAttributes&quot;, headerStorage[TICKET].getFrequentItemSetsDocument(ticketAttributes));</span>
            //将goodAttributes添加到doc
<span class="fc" id="L165">            doc.append(&quot;itemAttributes&quot;, headerStorage[type].getFrequentItemSetsDocument(goodAttributes));</span>
            //添加训练编号
<span class="fc" id="L167">            doc.append(TRAINING_NUMBER_FIELD, Integer.parseInt(trainingNumber));</span>
            //添加频次
<span class="fc" id="L169">            doc.append(&quot;Freq&quot;, Integer.parseInt(r.get(1).toString()));</span>
            //加入数据库
<span class="fc" id="L171">            collection.insertOne(doc);</span>
<span class="fc" id="L172">        }</span>
<span class="fc" id="L173">    }</span>

    /*
     * 关闭MongoDB连接
     */
    public static void closeMongoClient(int orderNumber,String comments,float minSupport){
<span class="pc bpc" id="L179" title="1 of 2 branches missed.">        if (!isClosed) {</span>
            //得到当前时间作为结束时间
<span class="fc" id="L181">            String endTime = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;).format(new Date());</span>
            //获取TrainingController集合
<span class="fc" id="L183">            MongoCollection&lt;Document&gt; collection = mongoDatabase.getCollection(&quot;TrainingController&quot;);</span>
            //写入训练信息
<span class="fc" id="L185">            Document doc = new Document();</span>
            //训练编号以整数形式存储
<span class="fc" id="L187">            doc.append(TRAINING_NUMBER_FIELD, Integer.parseInt(trainingNumber));</span>
            //训练开始时间
<span class="fc" id="L189">            doc.append(&quot;startTime&quot;, startTime);</span>
            //训练结束时间
<span class="fc" id="L191">            doc.append(&quot;endTime&quot;, endTime);</span>
            //训练的订单数量
<span class="fc" id="L193">            doc.append(&quot;orderNumber&quot;, orderNumber);</span>
            //备注
<span class="fc" id="L195">            doc.append(&quot;comments&quot;, comments);</span>
            //最小支持度
<span class="fc" id="L197">            doc.append(&quot;minSupport&quot;, minSupport);</span>
            //将doc加入数据库
<span class="fc" id="L199">            collection.insertOne(doc);</span>
            try{
                //关闭MongoDB连接
<span class="fc" id="L202">                mongoClient.close();</span>
<span class="nc" id="L203">            }catch(Exception e){</span>
<span class="nc" id="L204">                logger.info(&quot;关闭MongoDB连接失败！&quot; + e.getClass().getName() + &quot;: &quot; + e.getMessage());</span>
<span class="fc" id="L205">            }</span>
<span class="fc" id="L206">            isClosed = true;</span>
        }
<span class="fc" id="L208">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>